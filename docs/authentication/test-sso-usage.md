# ğŸ“‹ SSO æµ‹è¯•é¡µé¢ä½¿ç”¨è¯´æ˜

## å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶

```bash
# macOS
open docs/authentication/test-sso.html

# Linux
xdg-open docs/authentication/test-sso.html

# Windows
start docs/authentication/test-sso.html
```

### æ–¹æ³•2: ä½¿ç”¨ HTTP æœåŠ¡å™¨ï¼ˆæ¨èï¼‰

```bash
# è¿›å…¥æ–‡æ¡£ç›®å½•
cd docs/authentication

# Python 3
python3 -m http.server 8080

# Python 2
python -m SimpleHTTPServer 8080

# Node.js (éœ€è¦å®‰è£… http-server)
npx http-server -p 8080

# æµè§ˆå™¨è®¿é—®
open http://localhost:8080/test-sso.html
```

---

## âš™ï¸ å‰ç½®é…ç½®

### 1. å¯åŠ¨ AuthHub åç«¯

```bash
cd backend
docker-compose up -d  # æˆ–å…¶ä»–å¯åŠ¨æ–¹å¼
```

ç¡®ä¿åç«¯è¿è¡Œåœ¨ `http://localhost:8000`

### 2. é…ç½®é£ä¹¦åº”ç”¨å›è°ƒåœ°å€

ç™»å½• [é£ä¹¦å¼€æ”¾å¹³å°](https://open.feishu.cn/app)ï¼Œåœ¨ä½ çš„åº”ç”¨ä¸­æ·»åŠ å›è°ƒåœ°å€ï¼š

**ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶æ—¶**ï¼š
```
file:///Users/your-path/AuthHub/docs/authentication/test-sso.html
```

**ä½¿ç”¨ HTTP æœåŠ¡å™¨æ—¶ï¼ˆæ¨èï¼‰**ï¼š
```
http://localhost:8080/test-sso.html
```

> âš ï¸ **é‡è¦**: å›è°ƒåœ°å€å¿…é¡»å®Œå…¨åŒ¹é…ï¼ŒåŒ…æ‹¬åè®®ï¼ˆhttp/httpsï¼‰å’Œç«¯å£å·

---

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤ 1: é…ç½®

1. æ‰“å¼€æµ‹è¯•é¡µé¢åï¼Œæ£€æŸ¥ **AuthHub åç«¯åœ°å€** æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ **å›è°ƒåœ°å€** ä¸é£ä¹¦åº”ç”¨é…ç½®ä¸€è‡´

### æ­¥éª¤ 2: è·å–ç™»å½• URL

ç‚¹å‡» **"è·å–ç™»å½• URL"** æŒ‰é’®ï¼Œç³»ç»Ÿä¼šï¼š
- è°ƒç”¨ `POST /auth/sso/login-url` API
- ç”Ÿæˆé£ä¹¦æˆæƒé“¾æ¥
- è¿”å›é˜² CSRF çš„ `state` å‚æ•°

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "login_url": "https://open.feishu.cn/open-apis/authen/v1/index?app_id=cli_xxx&redirect_uri=http://localhost:8080/test-sso.html&state=abc123",
  "state": "abc123"
}
```

### æ­¥éª¤ 3: é£ä¹¦ç™»å½•

ç‚¹å‡» **"æ‰“å¼€é£ä¹¦ç™»å½•é¡µ"** æŒ‰é’®ï¼Œä¼šè·³è½¬åˆ°é£ä¹¦ç™»å½•é¡µé¢ï¼š

1. è¾“å…¥é£ä¹¦è´¦å·å¯†ç 
2. æˆæƒåº”ç”¨è®¿é—®ä½ çš„ä¿¡æ¯
3. è‡ªåŠ¨é‡å®šå‘å›æµ‹è¯•é¡µé¢ï¼ˆå¸¦ `code` å’Œ `state` å‚æ•°ï¼‰

### æ­¥éª¤ 4: è‡ªåŠ¨å¤„ç†å›è°ƒ

é¡µé¢æ£€æµ‹åˆ°å›è°ƒå‚æ•°åï¼Œä¼šè‡ªåŠ¨ï¼š
- è°ƒç”¨ `POST /auth/sso/exchange-token` API
- ç”¨ `code` å’Œ `state` äº¤æ¢ JWT Token
- ä¿å­˜ `access_token` å’Œ `refresh_token` åˆ° LocalStorage

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "aXJkN2w4ZmtkajM4ZmprZGpm...",
  "token_type": "bearer",
  "expires_in": 3600,
  "refresh_expires_in": 604800
}
```

### æ­¥éª¤ 5: è·å–ç”¨æˆ·ä¿¡æ¯

è‡ªåŠ¨è°ƒç”¨ `GET /auth/me` APIï¼Œæ˜¾ç¤ºï¼š
- ç”¨æˆ· ID
- ç”¨æˆ·å
- é‚®ç®±
- å…¨å±€è§’è‰²
- ç³»ç»Ÿè§’è‰²

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "sub": "1",
  "username": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "global_roles": ["developer"],
  "system_roles": {
    "data-center": ["admin"]
  }
}
```

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### 1. æµ‹è¯•åˆ·æ–° Token

ç‚¹å‡» **"ğŸ”„ æµ‹è¯•åˆ·æ–° Token"** æŒ‰é’®ï¼š
- è°ƒç”¨ `POST /auth/refresh` API
- ç”¨ `refresh_token` è·å–æ–°çš„ Token
- è‡ªåŠ¨æ›´æ–° LocalStorage

### 2. æŸ¥çœ‹ Token

ç‚¹å‡» **"ğŸ‘ï¸ æŸ¥çœ‹ Token"** æŒ‰é’®ï¼š
- æ˜¾ç¤ºå®Œæ•´çš„ `access_token` å’Œ `refresh_token`
- æ˜¾ç¤º Token é•¿åº¦ä¿¡æ¯

### 3. è·å–å…¬é’¥

ç‚¹å‡» **"ğŸ”‘ è·å–å…¬é’¥"** æŒ‰é’®ï¼š
- è°ƒç”¨ `GET /auth/public-key` API
- æ˜¾ç¤º RSA å…¬é’¥ï¼ˆç”¨äºæœ¬åœ°éªŒè¯ JWTï¼‰

### 4. è§£æ Token

ç‚¹å‡» **"ğŸ” è§£æ Token"** æŒ‰é’®ï¼š
- æœ¬åœ°è§£æ JWT Tokenï¼ˆä¸è°ƒç”¨ APIï¼‰
- æ˜¾ç¤º headerã€payloadã€signature

### 5. ç™»å‡º

ç‚¹å‡» **"ğŸšª ç™»å‡º"** æŒ‰é’®ï¼š
- è°ƒç”¨ `POST /auth/logout` API
- å°† Token åŠ å…¥é»‘åå•
- æ¸…é™¤ LocalStorage
- åˆ·æ–°é¡µé¢

---

## ğŸ› è°ƒè¯•åŠŸèƒ½

### å®æ—¶è°ƒè¯•æ—¥å¿—

é¡µé¢åº•éƒ¨çš„ **"è°ƒè¯•ä¿¡æ¯"** åŒºåŸŸä¼šå®æ—¶æ˜¾ç¤ºï¼š
- æ¯ä¸ª API è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
- è¯·æ±‚å‚æ•°å’Œå“åº”æ•°æ®
- é”™è¯¯ä¿¡æ¯å’Œå †æ ˆ

### å¤åˆ¶è°ƒè¯•ä¿¡æ¯

ç‚¹å‡» **"ğŸ“‹ å¤åˆ¶è°ƒè¯•ä¿¡æ¯"** æŒ‰é’®ï¼Œå¯ä»¥å°†æ‰€æœ‰æ—¥å¿—å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œæ–¹ä¾¿åˆ†äº«æˆ–æäº¤ Bug æŠ¥å‘Šã€‚

### æ¸…é™¤æœ¬åœ°å­˜å‚¨

ç‚¹å‡» **"ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°å­˜å‚¨"** æŒ‰é’®ï¼Œå¯ä»¥æ¸…é™¤æ‰€æœ‰ä¿å­˜çš„ Token å’Œç”¨æˆ·ä¿¡æ¯ï¼Œé‡ç½®æµ‹è¯•ç¯å¢ƒã€‚

---

## ğŸ“Š API ç«¯ç‚¹éªŒè¯

æµ‹è¯•é¡µé¢è°ƒç”¨çš„æ‰€æœ‰ API ç«¯ç‚¹ï¼š

| API ç«¯ç‚¹ | æ–¹æ³• | æµ‹è¯•æ­¥éª¤ | çŠ¶æ€ |
|---------|------|---------|:----:|
| `/auth/sso/login-url` | POST | æ­¥éª¤1: è·å–ç™»å½• URL | âœ… |
| `/auth/sso/exchange-token` | POST | æ­¥éª¤3: äº¤æ¢ Token | âœ… |
| `/auth/me` | GET | æ­¥éª¤4: è·å–ç”¨æˆ·ä¿¡æ¯ | âœ… |
| `/auth/refresh` | POST | æµ‹è¯•åˆ·æ–° Token | âœ… |
| `/auth/logout` | POST | ç™»å‡º | âœ… |
| `/auth/public-key` | GET | è·å–å…¬é’¥ | âœ… |

æ‰€æœ‰ç«¯ç‚¹å‡å·²éªŒè¯ï¼Œä¸åç«¯ä»£ç ä¸€è‡´ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç‚¹å‡»"æ‰“å¼€é£ä¹¦ç™»å½•é¡µ"åï¼Œé¡µé¢æ˜¾ç¤º"redirect_uri_mismatch"

**A**: é£ä¹¦åº”ç”¨é…ç½®çš„å›è°ƒåœ°å€ä¸å½“å‰é¡µé¢ URL ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æµ‹è¯•é¡µé¢ä¸Šæ˜¾ç¤ºçš„ **"å›è°ƒåœ°å€"**
2. ç™»å½•é£ä¹¦å¼€æ”¾å¹³å°ï¼Œåœ¨åº”ç”¨çš„ **"å®‰å…¨è®¾ç½® â†’ é‡å®šå‘ URL"** ä¸­æ·»åŠ è¯¥åœ°å€
3. ç¡®ä¿åè®®ï¼ˆhttp/httpsï¼‰ã€åŸŸåã€ç«¯å£ã€è·¯å¾„éƒ½å®Œå…¨ä¸€è‡´

### Q2: å›è°ƒåæ˜¾ç¤º "State éªŒè¯å¤±è´¥"

**A**: State å‚æ•°ä¸åŒ¹é…æˆ–å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é‡æ–°ç‚¹å‡» **"è·å–ç™»å½• URL"** ç”Ÿæˆæ–°çš„ state
2. ä¸è¦ç­‰å¾…å¤ªä¹…ï¼Œåœ¨ 5 åˆ†é’Ÿå†…å®Œæˆç™»å½•
3. ä¸è¦é‡å¤ä½¿ç”¨åŒä¸€ä¸ªç™»å½•é“¾æ¥

### Q3: æ˜¾ç¤º "Token å·²è¿‡æœŸ"

**A**: Access Token çš„æœ‰æ•ˆæœŸä¸º 1 å°æ—¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç‚¹å‡» **"ğŸ”„ æµ‹è¯•åˆ·æ–° Token"** è·å–æ–°çš„ Token
2. æˆ–é‡æ–°ç™»å½•

### Q4: æ— æ³•è¿æ¥åˆ° AuthHub åç«¯

**A**: åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–åœ°å€é…ç½®é”™è¯¯ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œï¼š`curl http://localhost:8000/docs`
2. ç¡®è®¤é¡µé¢é…ç½®çš„ **"AuthHub åç«¯åœ°å€"** æ­£ç¡®
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„ CORS é”™è¯¯ï¼ˆéœ€è¦åç«¯é…ç½® CORSï¼‰

### Q5: æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º CORS é”™è¯¯

**A**: AuthHub åç«¯æ²¡æœ‰é…ç½®å…è®¸å½“å‰åŸŸåè·¨åŸŸè®¿é—®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

ç¼–è¾‘ `backend/app/core/config.py`ï¼Œæ·»åŠ å½“å‰åŸŸååˆ° CORS ç™½åå•ï¼š

```python
CORS_ORIGINS: List[str] = [
    "http://localhost:3000",
    "http://localhost:5173",
    "http://localhost:8080",  # æ·»åŠ è¿™ä¸€è¡Œ
    "file://",  # å¦‚æœç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶
]
```

---

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS

```bash
# âŒ æµ‹è¯•ç¯å¢ƒ - HTTP
export AUTHHUB_URL="http://localhost:8000"

# âœ… ç”Ÿäº§ç¯å¢ƒ - HTTPS
export AUTHHUB_URL="https://authhub.example.com"
```

### 2. LocalStorage vs Cookie

å½“å‰æµ‹è¯•é¡µé¢ä½¿ç”¨ **LocalStorage** å­˜å‚¨ Tokenï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰ã€‚

ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ **HttpOnly Cookie**ï¼ˆæ›´å®‰å…¨ï¼‰ï¼š

```javascript
// âŒ ä¸æ¨èï¼ˆæ˜“å— XSS æ”»å‡»ï¼‰
localStorage.setItem('access_token', token);

// âœ… æ¨èï¼ˆé˜²æ­¢ XSSï¼‰
document.cookie = `access_token=${token}; HttpOnly; Secure; SameSite=Lax`;
```

### 3. ä¸è¦åœ¨å…¬ç½‘æš´éœ²æµ‹è¯•é¡µé¢

æµ‹è¯•é¡µé¢ä»…ç”¨äºå¼€å‘å’Œè°ƒè¯•ï¼Œä¸è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

---

## ğŸ“¸ ç•Œé¢æˆªå›¾è¯´æ˜

### ç™»å½•å‰

- æ˜¾ç¤º **"âš ï¸ æœªç™»å½•"** çŠ¶æ€
- 4 ä¸ªæ­¥éª¤æŒ‰é’®ï¼ˆæ­¥éª¤ 2-4 ç¦ç”¨ï¼‰
- ç©ºç™½çš„è°ƒè¯•åŒºåŸŸ

### ç™»å½•å

- æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å¡ç‰‡ï¼š
  - ç”¨æˆ· IDã€ç”¨æˆ·åã€é‚®ç®±
  - å…¨å±€è§’è‰²ï¼ˆç´«è‰²å¾½ç« ï¼‰
  - ç³»ç»Ÿè§’è‰²ï¼ˆç»¿è‰²å¾½ç« ï¼‰
- ç™»å‡ºã€åˆ·æ–°ã€æŸ¥çœ‹ Token æŒ‰é’®å¯ç”¨
- è°ƒè¯•åŒºåŸŸæ˜¾ç¤ºå®Œæ•´çš„è¯·æ±‚æ—¥å¿—

---

## ğŸ¨ ç•Œé¢å®šåˆ¶

æµ‹è¯•é¡µé¢ä½¿ç”¨çº¯ HTML + CSS + JavaScriptï¼Œæ— éœ€ä»»ä½•æ„å»ºå·¥å…·ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ï¼š

### ä¿®æ”¹é…ç½®

ç¼–è¾‘ HTML æ–‡ä»¶ç¬¬ 350 è¡Œï¼š

```javascript
const config = {
    getAuthhubUrl: () => document.getElementById('authhub-url').value.replace(/\/$/, ''),
    getCallbackUrl: () => window.location.origin + window.location.pathname,
};
```

### ä¿®æ”¹æ ·å¼

åœ¨ `<style>` æ ‡ç­¾ä¸­ä¿®æ”¹ CSSï¼ˆç¬¬ 9-283 è¡Œï¼‰ï¼š

```css
/* ä¿®æ”¹ä¸»é¢˜è‰² */
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰çš„é”™è¯¯ä¿¡æ¯
2. æŸ¥çœ‹æµ‹è¯•é¡µé¢çš„ **"è°ƒè¯•ä¿¡æ¯"** åŒºåŸŸ
3. å¤åˆ¶è°ƒè¯•ä¿¡æ¯å¹¶æäº¤ Issue
4. å‚è€ƒ [Curl è®¤è¯æŒ‡å—](./curl-authentication-guide.md)

---

## ğŸ“… æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| 2024-11-24 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´çš„ SSO æµ‹è¯•é¡µé¢ |

