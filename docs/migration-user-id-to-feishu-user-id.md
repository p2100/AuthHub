# ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ID å­—æ®µåˆ‡æ¢è‡³é£ä¹¦ç”¨æˆ· ID ä¿®æ”¹è®¡åˆ’

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-11-28
**ä¿®æ”¹èŒƒå›´**: å…¨ç³»ç»Ÿç”¨æˆ·ç®¡ç†æ ‡è¯†å­—æ®µåˆ‡æ¢
**ä¼˜å…ˆçº§**: é«˜

---

## ğŸ“‹ ç›®å½•

- [1. é¡¹ç›®èƒŒæ™¯](#1-é¡¹ç›®èƒŒæ™¯)
- [2. ç°çŠ¶åˆ†æ](#2-ç°çŠ¶åˆ†æ)
  - [2.1 æ•°æ®åº“å±‚é¢](#21-æ•°æ®åº“å±‚é¢)
  - [2.2 åç«¯å±‚é¢](#22-åç«¯å±‚é¢)
  - [2.3 å‰ç«¯å±‚é¢](#23-å‰ç«¯å±‚é¢)
- [3. ä¿®æ”¹ç›®æ ‡](#3-ä¿®æ”¹ç›®æ ‡)
- [4. è¯¦ç»†å®æ–½è®¡åˆ’](#4-è¯¦ç»†å®æ–½è®¡åˆ’)
  - [4.1 ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è¿ç§»](#41-ç¬¬ä¸€é˜¶æ®µæ•°æ®åº“è¿ç§»)
  - [4.2 ç¬¬äºŒé˜¶æ®µï¼šåç«¯ä»£ç é‡æ„](#42-ç¬¬äºŒé˜¶æ®µåç«¯ä»£ç é‡æ„)
  - [4.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ä»£ç é‡æ„](#43-ç¬¬ä¸‰é˜¶æ®µå‰ç«¯ä»£ç é‡æ„)
  - [4.4 ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•éªŒè¯](#44-ç¬¬å››é˜¶æ®µæµ‹è¯•éªŒè¯)
  - [4.5 ç¬¬äº”é˜¶æ®µï¼šéƒ¨ç½²ä¸Šçº¿](#45-ç¬¬äº”é˜¶æ®µéƒ¨ç½²ä¸Šçº¿)
- [5. é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹](#5-é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹)
  - [5.1 å…¼å®¹æ€§å¤„ç†](#51-å…¼å®¹æ€§å¤„ç†)
  - [5.2 æ•°æ®ä¸€è‡´æ€§](#52-æ•°æ®ä¸€è‡´æ€§)
  - [5.3 æ€§èƒ½ä¼˜åŒ–](#53-æ€§èƒ½ä¼˜åŒ–)
  - [5.4 å›æ»šæ–¹æ¡ˆ](#54-å›æ»šæ–¹æ¡ˆ)
- [6. æ¶‰åŠæ–‡ä»¶æ¸…å•](#6-æ¶‰åŠæ–‡ä»¶æ¸…å•)
  - [6.1 åç«¯æ–‡ä»¶](#61-åç«¯æ–‡ä»¶)
  - [6.2 å‰ç«¯æ–‡ä»¶](#62-å‰ç«¯æ–‡ä»¶)
  - [6.3 æ•°æ®åº“è¡¨](#63-æ•°æ®åº“è¡¨)
- [7. æ—¶é—´ä¼°ç®—](#7-æ—¶é—´ä¼°ç®—)
- [8. ç›¸å…³æ–‡æ¡£](#8-ç›¸å…³æ–‡æ¡£)

---

## 1. é¡¹ç›®èƒŒæ™¯

å½“å‰ç³»ç»Ÿç”¨æˆ·ç®¡ç†ä½“ç³»åŸºäºè‡ªå¢æ•´å‹ `id` å­—æ®µä½œä¸ºç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼Œæ‰€æœ‰ä¸šåŠ¡å…³è”ã€æƒé™ç®¡ç†ã€API è°ƒç”¨å‡ä¾èµ–æ­¤å­—æ®µã€‚éšç€ç³»ç»Ÿä¸é£ä¹¦ç”Ÿæ€çš„æ·±åº¦èåˆï¼Œå†…éƒ¨ ID ä¸é£ä¹¦ç”¨æˆ·æ ‡è¯† `feishu_user_id` ä¹‹é—´çš„æ˜ å°„å¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§ã€‚

ä¸ºç®€åŒ–æ¶æ„ã€æå‡ç³»ç»Ÿä¸€è‡´æ€§ï¼Œå†³å®šå°†ç”¨æˆ·ç®¡ç†çš„ä¸»æ ‡è¯†ä» `id` å­—æ®µåˆ‡æ¢è‡³ `feishu_user_id` å­—æ®µï¼Œå®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

- **ç»Ÿä¸€æ ‡è¯†ä½“ç³»**ï¼šç›´æ¥ä½¿ç”¨é£ä¹¦ç”¨æˆ· IDï¼Œæ¶ˆé™¤å†…å¤–éƒ¨æ ‡è¯†æ˜ å°„
- **é™ä½ç»´æŠ¤æˆæœ¬**ï¼šç®€åŒ–ç”¨æˆ·åŒæ­¥ã€æƒé™ç®¡ç†ç­‰æ ¸å¿ƒé€»è¾‘
- **æå‡æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥å¤šç§Ÿæˆ·ã€å¤šèº«ä»½æºæ¥å…¥å¥ å®šåŸºç¡€

---

## 2. ç°çŠ¶åˆ†æ

### 2.1 æ•°æ®åº“å±‚é¢

| è¡¨å | å½“å‰å­—æ®µ | å¤–é”®å…³è” | å½±å“ç¨‹åº¦ |
|------|---------|---------|---------|
| `users` | `id` (PK, int) `feishu_user_id` (UK, string) | ä¸»è¡¨ | ğŸ”´ é«˜ |
| `user_roles` | `user_id` (FKâ†’users.id, int) `created_by` (int) | ç”¨æˆ·è§’è‰²å…³è” | ğŸ”´ é«˜ |
| `resource_bindings` | `user_id` (FKâ†’users.id, int) `created_by` (int) | èµ„æºæƒé™ç»‘å®š | ğŸ”´ é«˜ |
| `audit_logs` | `operator_id` (FKâ†’users.id, int)<br>`target_id` (int, å¤šæ€) | å®¡è®¡æ—¥å¿— (target_id éœ€æ”¹ä¸º String ä»¥æ”¯æŒ feishu_user_id) | ğŸ”´ é«˜ |

**å½“å‰ Schema ç‰¹ç‚¹ï¼š**
- `users` è¡¨é‡‡ç”¨è‡ªå¢æ•´å‹ `id` ä½œä¸ºä¸»é”®
- `feishu_user_id` å­—æ®µå·²å­˜åœ¨ï¼Œå…·æœ‰å”¯ä¸€ç´¢å¼•ï¼Œç”¨äºå­˜å‚¨é£ä¹¦ç”¨æˆ·æ ‡è¯†
- å¤šä¸ªä¸šåŠ¡è¡¨é€šè¿‡ `user_id` å¤–é”®å…³è”åˆ° `users.id`
- JWT Token çš„ `sub` å­—æ®µå­˜å‚¨çš„æ˜¯ `user.id`

### 2.2 åç«¯å±‚é¢

**æ ¸å¿ƒæœåŠ¡å±‚ï¼ˆapp/users/service.pyï¼‰ï¼š**
```python
# å½“å‰å®ç°
async def get_user_by_id(self, user_id: int) -> Optional[User]
async def update_user_status(self, user_id: int, status: str) -> Optional[User]
async def update_user_departments(self, user_id: int, dept_ids: list, dept_names: list)
```

**è®¤è¯ç³»ç»Ÿï¼ˆapp/auth/router.py å’Œ app/core/security.pyï¼‰ï¼š**
- JWT Token ç”Ÿæˆï¼š`sub` å­—æ®µä½¿ç”¨ `user.id`
- Token åˆ·æ–°ï¼šé€šè¿‡ `user.id` æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- æƒé™æ”¶é›†ï¼šåŸºäº `user.id` èšåˆç”¨æˆ·è§’è‰²å’Œèµ„æºæƒé™

**RBAC ç³»ç»Ÿï¼ˆapp/rbac/service.pyï¼‰ï¼š**
- è§’è‰²åˆ†é…ï¼š`assign_role_to_user(user_id: int, ...)`
- èµ„æºç»‘å®šï¼šæ‰€æœ‰æ–¹æ³•æ¥å— `user_id: int` å‚æ•°
- è·¯ç”±è§„åˆ™ï¼šåŸºäºç”¨æˆ· ID çš„æƒé™åˆ¤æ–­

**API è·¯ç”±å±‚ï¼š**
```python
# å½“å‰è·¯å¾„å‚æ•°
@router.get("/users/{user_id}")
@router.put("/users/{user_id}/status")
@router.get("/users/{user_id}/roles")
@router.get("/users/{user_id}/permissions")
```

### 2.3 å‰ç«¯å±‚é¢

**API ç±»å‹å®šä¹‰ï¼ˆsrc/types/api.tsï¼‰ï¼š**
```typescript
export interface User {
  id: number              // å½“å‰ä¸»æ ‡è¯†
  feishu_user_id: string  // é£ä¹¦ç”¨æˆ·ID
  username: string
  email?: string
  // ...
}
```

**ç»„ä»¶å®ç°ï¼ˆsrc/pages/Users/UserList.tsxï¼‰ï¼š**
- è¡¨æ ¼ rowKey ä½¿ç”¨ `"id"`
- æ“ä½œæŒ‰é’®ä¼ é€’ `userId: number` å‚æ•°
- çŠ¶æ€æ›´æ–° API è°ƒç”¨ `/users/${userId}/status`

**è®¤è¯ä¸Šä¸‹æ–‡ï¼ˆsrc/contexts/AuthContext.tsxï¼‰ï¼š**
- JWT Token è§£æå `sub` å­—æ®µä¸ºå­—ç¬¦ä¸²ï¼ˆuser.id çš„å­—ç¬¦ä¸²å½¢å¼ï¼‰
- å½“å‰æœªç›´æ¥ä½¿ç”¨ç”¨æˆ· ID è¿›è¡Œä¸šåŠ¡æ“ä½œ

---

## 3. ä¿®æ”¹ç›®æ ‡

### 3.1 æ ¸å¿ƒæŠ€æœ¯ç›®æ ‡

1. **æ•°æ®åº“å±‚**
   - å°†æ‰€æœ‰ `user_id` å¤–é”®å­—æ®µç±»å‹ä» `int` æ”¹ä¸º `string`
   - å¤–é”®å¼•ç”¨ä» `users.id` æ”¹ä¸º `users.feishu_user_id`
   - ä¿æŒ `users.id` ä½œä¸ºå†…éƒ¨æ ‡è¯†ï¼Œä½†ä¸ç”¨äºä¸šåŠ¡å…³è”

2. **è®¤è¯æˆæƒå±‚**
   - JWT Token çš„ `sub` å­—æ®µæ”¹ä¸ºå­˜å‚¨ `feishu_user_id`
   - Token åˆ·æ–°é€»è¾‘åŸºäº `feishu_user_id` æŸ¥è¯¢ç”¨æˆ·
   - æƒé™æ”¶é›†å’ŒéªŒè¯åŸºäº `feishu_user_id`

3. **API æ¥å£å±‚**
   - æ‰€æœ‰ç”¨æˆ·ç›¸å…³ API ä»æ¥å— `user_id: int` æ”¹ä¸º `feishu_user_id: string`
   - URL è·¯å¾„å‚æ•°æ›´æ–°ä¸º `/users/{feishu_user_id}`
   - ä¿æŒ API ç‰ˆæœ¬çš„å‘åå…¼å®¹æ€§ï¼ˆå¯é€‰ï¼‰

4. **å‰ç«¯åº”ç”¨å±‚**
   - User æ¥å£çš„ `id` å­—æ®µæ”¹ä¸º `feishu_user_id: string`
   - ç»„ä»¶é€»è¾‘ä½¿ç”¨é£ä¹¦ç”¨æˆ· ID è¿›è¡Œæ“ä½œ
   - è¡¨æ ¼ rowKey ç­‰æ ‡è¯†å­—æ®µæ›´æ–°

### 3.2 ä¸šåŠ¡ä»·å€¼ç›®æ ‡

- âœ¨ **ç®€åŒ–ç³»ç»Ÿé›†æˆ**ï¼šç›´æ¥ä½¿ç”¨é£ä¹¦ç”¨æˆ· IDï¼Œæ— éœ€ç»´æŠ¤æ˜ å°„å…³ç³»
- ğŸš€ **æå‡å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€æ ‡è¯†ä½“ç³»ï¼Œå‡å°‘è½¬æ¢é€»è¾‘
- ğŸ”’ **å¢å¼ºæ•°æ®ä¸€è‡´æ€§**ï¼šä»æºå¤´ç»Ÿä¸€ç”¨æˆ·æ ‡è¯†
- ğŸ“ˆ **æ”¯æŒæœªæ¥æ‰©å±•**ï¼šä¸ºå¤šèº«ä»½æºæ¥å…¥å¥ å®šåŸºç¡€

---

## 4. è¯¦ç»†å®æ–½è®¡åˆ’

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“è¿ç§»

#### 4.1.1 åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬

**æ‰§è¡Œå‘½ä»¤ï¼š**
```bash
cd /Users/leo/code/work/AuthHub/backend
alembic revision -m "migrate_user_id_to_feishu_user_id"
```

**è¿ç§»è„šæœ¬æ ¸å¿ƒå†…å®¹ï¼š**

```python
"""Migrate user_id to feishu_user_id

Revision ID: xxxxxxx
Revises: 836823124d94
Create Date: 2025-11-28

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa


def upgrade() -> None:
    # 1. ä¸º users è¡¨ feishu_user_id å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆå¦‚ä¸å­˜åœ¨ï¼‰
    op.create_index('ix_users_feishu_user_id', 'users', ['feishu_user_id'], unique=False)

    # 2. æ›´æ–° user_roles è¡¨
    # 2.1 æ·»åŠ æ–°å­—æ®µï¼ˆfeishu_user_idï¼‰
    op.add_column('user_roles', sa.Column('user_feishu_user_id', sa.String(100), nullable=True))
    op.add_column('user_roles', sa.Column('creator_feishu_user_id', sa.String(100), nullable=True))

    # 2.2 æ•°æ®è¿ç§»ï¼šå°† user_id è½¬æ¢ä¸º feishu_user_id
    op.execute("""
        UPDATE user_roles ur
        SET user_feishu_user_id = (SELECT feishu_user_id FROM users u WHERE u.id = ur.user_id)
        WHERE ur.user_feishu_user_id IS NULL
    """)
    op.execute("""
        UPDATE user_roles ur
        SET creator_feishu_user_id = (SELECT feishu_user_id FROM users u WHERE u.id = ur.created_by)
        WHERE ur.creator_feishu_user_id IS NULL AND ur.created_by IS NOT NULL
    """)

    # 2.3 åˆ é™¤æ—§å¤–é”®çº¦æŸ
    op.drop_constraint('user_roles_user_id_fkey', 'user_roles', type_='foreignkey')
    op.drop_constraint('user_roles_created_by_fkey', 'user_roles', type_='foreignkey')

    # 2.4 åˆ é™¤æ—§å­—æ®µ
    op.drop_column('user_roles', 'user_id')
    op.drop_column('user_roles', 'created_by')

    # 2.5 é‡å‘½åå­—æ®µ
    op.alter_column('user_roles', 'user_feishu_user_id', new_column_name='user_id')
    op.alter_column('user_roles', 'creator_feishu_user_id', new_column_name='created_by')

    # 2.6 æ·»åŠ æ–°å¤–é”®çº¦æŸ
    op.create_foreign_key('user_roles_user_id_fkey', 'user_roles', 'users', ['user_id'], ['feishu_user_id'], ondelete='CASCADE')
    op.create_foreign_key('user_roles_created_by_fkey', 'user_roles', 'users', ['created_by'], ['feishu_user_id'])

    # 3. æ›´æ–° resource_bindings è¡¨ï¼ˆç±»ä¼¼æ­¥éª¤ï¼‰
    # ...

    # 4. æ›´æ–° audit_logs è¡¨
    # 4.1 operator_id è¿ç§» (é€»è¾‘åŒ user_roles)
    op.add_column('audit_logs', sa.Column('operator_feishu_user_id', sa.String(100), nullable=True))
    op.execute("""
        UPDATE audit_logs al
        SET operator_feishu_user_id = (SELECT feishu_user_id FROM users u WHERE u.id = al.operator_id)
        WHERE al.operator_id IS NOT NULL
    """)
    # ... (åˆ é™¤æ—§å¤–é”®ï¼Œé‡å‘½åæ–°å­—æ®µç­‰)

    # 4.2 target_id ç±»å‹å˜æ›´ (å…³é”®é£é™©ç‚¹)
    # target_id æ˜¯å¤šæ€å­—æ®µï¼Œå­˜å‚¨ User/Role/Permission çš„ IDã€‚
    # å˜ä¸º String ä»¥å…¼å®¹ feishu_user_idã€‚
    op.alter_column('audit_logs', 'target_id',
               existing_type=sa.Integer(),
               type_=sa.String(length=100),
               postgresql_using='target_id::varchar')


def downgrade() -> None:
    # æä¾›å›æ»šé€»è¾‘
    pass
```

#### 4.1.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

```sql
-- éªŒè¯è¿ç§»åæ•°æ®å®Œæ•´æ€§
SELECT
    ur.id,
    ur.user_id as feishu_user_id,
    u.feishu_user_id as expected_feishu_user_id,
    ur.created_by
FROM user_roles ur
JOIN users u ON ur.user_id = u.feishu_user_id
WHERE ur.user_id IS NOT NULL;

-- æ£€æŸ¥æ˜¯å¦æœ‰å­¤å„¿è®°å½•
SELECT COUNT(*)
FROM user_roles ur
LEFT JOIN users u ON ur.user_id = u.feishu_user_id
WHERE u.feishu_user_id IS NULL;
```

**é¢„è®¡è€—æ—¶**: 4-6å°æ—¶
**æ‰§è¡Œäººå‘˜**: åç«¯å¼€å‘ + DBA
**éªŒè¯æ ‡å‡†**:
- è¿ç§»åæ•°æ®å®Œæ•´æ€§ 100%
- æ‰€æœ‰å¤–é”®çº¦æŸæ­£å¸¸
- ç´¢å¼•ç”Ÿæ•ˆ

---

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šåç«¯ä»£ç é‡æ„

#### 4.2.1 ä¿®æ”¹æ ¸å¿ƒè®¤è¯æ¨¡å—

**æ–‡ä»¶**: `app/core/security.py`

```python
# ä¿®æ”¹å‰
def create_access_token(
    self,
    user_id: int,  # æ•´å‹ ID
    feishu_user_id: str,
    # ...
) -> str:
    payload = {
        "sub": str(user_id),  # è½¬æ¢ä¸ºå­—ç¬¦ä¸²
        # ...
    }

# ä¿®æ”¹å
def create_access_token(
    self,
    feishu_user_id: str,  # ç›´æ¥ä½¿ç”¨é£ä¹¦ç”¨æˆ· ID
    username: str,
    # ... ç§»é™¤ user_id å‚æ•°
) -> str:
    payload = {
        "sub": feishu_user_id,  # ç›´æ¥ä½¿ç”¨
        # ...
    }
```

**æ–‡ä»¶**: `app/core/dependencies.py`

```python
# ä¿®æ”¹å‰ï¼šuser_id æ˜¯æ•´å‹å­—ç¬¦ä¸²
payload = jwt.decode(token, public_key, algorithms=[settings.JWT_ALGORITHM])
user_id = int(payload.get("sub"))  # éœ€è¦è½¬æ¢

# ä¿®æ”¹åï¼šsub ç›´æ¥æ˜¯ feishu_user_id
payload = jwt.decode(token, public_key, algorithms=[settings.JWT_ALGORITHM])
feishu_user_id = payload.get("sub")  # ç›´æ¥ä½¿ç”¨
```

#### 4.2.2 é‡æ„ UserService

**æ–‡ä»¶**: `app/users/service.py`

```python
# ä¿®æ”¹å‰
class UserService:
    async def get_user_by_id(self, user_id: int) -> Optional[User]:
        result = await self.db.execute(select(User).filter(User.id == user_id))
        return result.scalar_one_or_none()

# ä¿®æ”¹å
class UserService:
    async def get_user_by_feishu_id(self, feishu_user_id: str) -> Optional[User]:
        result = await self.db.execute(
            select(User).filter(User.feishu_user_id == feishu_user_id)
        )
        return result.scalar_one_or_none()

    # ä¿ç•™æ–¹æ³•åä½†æ›´æ–°å®ç°ï¼Œæˆ–é‡å‘½
    async def get_user_by_id(self, user_id: str) -> Optional[User]:  # æ”¹ä¸º string
        result = await self.db.execute(
            select(User).filter(User.feishu_user_id == user_id)
        )
        return result.scalar_one_or_none()
```

**åŒæ­¥ç”¨æˆ·æ–¹æ³•ä¿®æ”¹ï¼š**
```python
# ä¿®æ”¹å‰
async def sync_user_from_feishu(self, user_info: Dict) -> User:
    feishu_user_id = user_info.get("user_id") or user_info.get("open_id")
    result = await self.db.execute(
        select(User).filter(User.feishu_user_id == feishu_user_id)
    )
    user = result.scalar_one_or_none()
    # ... åˆ›å»ºæˆ–æ›´æ–°
    return user  # è¿”å›çš„ user.id ç”¨äºåç»­æ“ä½œ

# ä¿®æ”¹å - ä¿æŒé€»è¾‘ä¸å˜ï¼Œä½†åç»­æ“ä½œä½¿ç”¨ feishu_user_id
```

#### 4.2.3 æ›´æ–° API è·¯ç”±

**æ–‡ä»¶**: `app/users/router.py`

```python
# ä¿®æ”¹å‰
@router.get("/{user_id}", response_model=UserDetailResponse)
async def get_user(
    user_id: int,  # æ•´å‹å‚æ•°
    # ...
):
    user = await user_service.get_user_by_id(user_id)
    # ...

# ä¿®æ”¹å
@router.get("/{feishu_user_id}", response_model=UserDetailResponse)
async def get_user(
    feishu_user_id: str,  # å­—ç¬¦ä¸²å‚æ•°
    # ...
):
    user = await user_service.get_user_by_feishu_id(feishu_user_id)
    # ...
```

**æ‰¹é‡ä¿®æ”¹è·¯ç”±ï¼š**
- `GET /users/{user_id}` â†’ `GET /users/{feishu_user_id}`
- `PUT /users/{user_id}/status` â†’ `PUT /users/{feishu_user_id}/status`
- `GET /users/{user_id}/roles` â†’ `GET /users/{feishu_user_id}/roles`
- `GET /users/{user_id}/permissions` â†’ `GET /users/{feishu_user_id}/permissions`

#### 4.2.4 é‡æ„ RBAC ç³»ç»Ÿ

**æ–‡ä»¶**: `app/rbac/service.py`

```python
# ä¿®æ”¹å‰
async def assign_role_to_user(self, user_id: int, role_id: int, created_by: Optional[int] = None):
    user_role = UserRole(
        user_id=user_id,  # æ•´å‹
        role_id=role_id,
        created_by=created_by
    )
    # ...
    permission_notifier.notify_user_permissions_changed(user_id)

# è¡¥å……ä¿®æ”¹ï¼šé€šçŸ¥å™¨å‚æ•°ç±»å‹
# æ–‡ä»¶: app/rbac/notifier.py
# def notify_user_permissions_changed(self, user_id: int) -> void
# æ”¹ä¸º:
# def notify_user_permissions_changed(self, user_id: str) -> void

# ä¿®æ”¹å
async def assign_role_to_user(self, user_id: str, role_id: int, created_by: Optional[str] = None):
    user_role = UserRole(
        user_id=user_id,  # å­—ç¬¦ä¸²ç±»å‹
        role_id=role_id,
        created_by=created_by
    )
    # ...
    permission_notifier.notify_user_permissions_changed(user_id)
```

#### 4.2.5 æ›´æ–°è®¤è¯ç›¸å…³ä»£ç 

**æ–‡ä»¶**: `app/auth/router.py`

```python
# é£ä¹¦ç™»å½•å›è°ƒ - Token ç”Ÿæˆéƒ¨åˆ†
# ä¿®æ”¹å‰
token = jwt_handler.create_access_token(
    user_id=user.id,  # æ•´å‹
    feishu_user_id=user.feishu_user_id,
    # ...
)

# ä¿®æ”¹å
token = jwt_handler.create_access_token(
    feishu_user_id=user.feishu_user_id,  # ç›´æ¥ä½¿ç”¨
    username=user.username,
    # ... ç§»é™¤ user_id å‚æ•°
)
```

**Token åˆ·æ–°æ¥å£ï¼š**
```python
# ä¿®æ”¹å‰ - ä» refresh token è·å– user_idï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
user_id = jwt_handler.verify_refresh_token(request.refresh_token)
result = await db.execute(select(User).where(User.id == user_id))

# ä¿®æ”¹å - éœ€è¦è°ƒæ•´ refresh token å­˜å‚¨æ–¹å¼
# æ–¹æ¡ˆï¼šåœ¨ refresh token ä¸­å­˜å‚¨ feishu_user_id
# æ³¨æ„ï¼šåŒæ—¶éœ€æ›´æ–° Redis å­˜å‚¨é€»è¾‘ (set/get) ä»¥æ”¯æŒå­—ç¬¦ä¸² ID
feishu_user_id = jwt_handler.verify_refresh_token(request.refresh_token)
result = await db.execute(select(User).where(User.feishu_user_id == feishu_user_id))
```

#### 4.2.6 æ›´æ–° Schemas

**æ–‡ä»¶**: `app/schemas/user.py`

```python
# ä¿®æ”¹å‰
class UserResponse(BaseModel):
    id: int  # æ•´å‹
    feishu_user_id: str
    # ...

# ä¿®æ”¹å
class UserResponse(BaseModel):
    feishu_user_id: str  # ä½œä¸ºä¸»æ ‡è¯†
    username: str
    # ...
    # å¯é€‰ï¼šä¿ç•™ id å­—æ®µç”¨äºå†…éƒ¨è°ƒè¯•
    internal_id: Optional[int] = None
```

**é¢„è®¡è€—æ—¶**: 8-12å°æ—¶
**æ‰§è¡Œäººå‘˜**: åç«¯å¼€å‘å›¢é˜Ÿï¼ˆ2äººï¼‰
**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰ API æµ‹è¯•é€šè¿‡
- Token ç”Ÿæˆå’ŒéªŒè¯æ­£å¸¸
- RBAC åŠŸèƒ½å®Œæ•´

---

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ä»£ç é‡æ„

#### 4.3.1 æ›´æ–° API ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/types/api.ts`

```typescript
// ä¿®æ”¹å‰
export interface User {
  id: number              // ä¸»æ ‡è¯†
  feishu_user_id: string
  username: string
  // ...
}

// ä¿®æ”¹å
export interface User {
  feishu_user_id: string  // ä¸»æ ‡è¯†ï¼ˆå­—ç¬¦ä¸²ï¼‰
  username: string
  // ...
  // å¯é€‰ï¼šä¿ç•™å†…éƒ¨ ID ç”¨äºç‰¹æ®Šåœºæ™¯
  internal_id?: number
}

// æ›´æ–°ç›¸å…³æ¥å£
export interface AssignRoleRequest {
  user_id: string  // æ”¹ä¸º string
  role_id: number
}

export interface ResourceBinding {
  id: number
  user_id: string  // æ”¹ä¸º string
  created_by: string // æ”¹ä¸º string
  // ...
}

export interface UserRole {
  // ...
  created_by?: string // æ”¹ä¸º string
}

export interface ResourceBindingCreate {
  user_id: string // æ”¹ä¸º string
  // ...
}
```

#### 4.3.2 æ›´æ–°ç»„ä»¶ä»£ç 

**æ–‡ä»¶**: `src/pages/Users/UserList.tsx`

```typescript
// ä¿®æ”¹å‰
columns = [
  {
    title: 'æ“ä½œ',
    render: (_: any, record: User) => (
      <Space>
        <Button onClick={() => handleViewPermissions(record.id)}>
          æŸ¥çœ‹æƒé™
        </Button>
        <Button onClick={() => handleAssignRole(record.id)}>
          åˆ†é…è§’è‰²
        </Button>
      </Space>
    ),
  },
]

<Table
  rowKey="id"  // ä½¿ç”¨ id
  dataSource={data?.items || []}
/>

// ä¿®æ”¹å
columns = [
  {
    title: 'æ“ä½œ',
    render: (_: any, record: User) => (
      <Space>
        <Button onClick={() => handleViewPermissions(record.feishu_user_id)}>
          æŸ¥çœ‹æƒé™
        </Button>
        <Button onClick={() => handleAssignRole(record.feishu_user_id)}>
          åˆ†é…è§’è‰²
        </Button>
      </Space>
    ),
  },
]

<Table
  rowKey="feishu_user_id"  // ä½¿ç”¨é£ä¹¦ç”¨æˆ· ID
  dataSource={data?.items || []}
/>
```

**çŠ¶æ€æ›´æ–°å‡½æ•°ï¼š**
```typescript
// ä¿®æ”¹å‰
const handleStatusChange = (userId: number, checked: boolean) => {
  updateStatusMutation.mutate({
    userId,  // number
    status: checked ? 'active' : 'inactive',
  })
}

// ä¿®æ”¹å
const handleStatusChange = (userId: string, checked: boolean) => {
  updateStatusMutation.mutate({
    userId,  // string
    status: checked ? 'active' : 'inactive',
  })
}
```

#### 4.3.3 æ›´æ–°ç»„ä»¶ Props æ¥å£

**æ–‡ä»¶**: `src/pages/Users/components/UserPermissionModal.tsx`

```typescript
// ä¿®æ”¹å‰
interface Props {
  userId: number
  username: string
  visible: boolean
  onClose: () => void
}

// ä¿®æ”¹å
interface Props {
  userId: string  // æ”¹ä¸º string
  username: string
  visible: boolean
  onClose: () => void
}
```

#### 4.3.4 æ›´æ–° API è¯·æ±‚

**æ–‡ä»¶**: `src/utils/api.ts`

```typescript
// ä¿®æ”¹å‰ - æ¥å£è°ƒç”¨
export const updateUserStatus = (userId: number, status: 'active' | 'inactive') => {
  return apiPut<User>(`/users/${userId}/status`, { status })
}

export const getUserPermissions = (userId: number) => {
  return apiGet<UserPermissionDetail>(`/users/${userId}/permissions`)
}

// ä¿®æ”¹å
export const updateUserStatus = (userId: string, status: 'active' | 'inactive') => {
  return apiPut<User>(`/users/${userId}/status`, { status })
}

export const getUserPermissions = (userId: string) => {
  return apiGet<UserPermissionDetail>(`/users/${userId}/permissions`)
}
```

**é¢„è®¡è€—æ—¶**: 6-8å°æ—¶
**æ‰§è¡Œäººå‘˜**: å‰ç«¯å¼€å‘å›¢é˜Ÿï¼ˆ1-2äººï¼‰
**éªŒè¯æ ‡å‡†**:
- æ‰€æœ‰é¡µé¢æ­£å¸¸æ¸²æŸ“
- ç”¨æˆ·æ“ä½œåŠŸèƒ½å®Œæ•´
- TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡

---

### 4.4 ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•éªŒè¯

#### 4.4.1 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `tests/users/test_service.py`

```python
# æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
@pytest.mark.asyncio
async def test_get_user_by_feishu_id(db_session, test_user):
    """æµ‹è¯•é€šè¿‡ feishu_user_id è·å–ç”¨æˆ·"""
    service = UserService(db_session)
    user = await service.get_user_by_feishu_id(test_user.feishu_user_id)

    assert user is not None
    assert user.feishu_user_id == test_user.feishu_user_id
    assert user.username == test_user.username

@pytest.mark.asyncio
async def test_update_user_status_by_feishu_id(db_session, test_user):
    """æµ‹è¯•é€šè¿‡ feishu_user_id æ›´æ–°ç”¨æˆ·çŠ¶æ€"""
    service = UserService(db_session)
    updated = await service.update_user_status(
        test_user.feishu_user_id,
        'inactive'
    )

    assert updated is not None
    assert updated.status == 'inactive'
```

#### 4.4.2 é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯æ¸…å•ï¼š**

| åœºæ™¯ | æµ‹è¯•ç‚¹ | æœŸæœ›ç»“æœ |
|------|--------|---------|
| é£ä¹¦ç™»å½• | æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½• | æˆåŠŸåˆ›å»ºç”¨æˆ·ï¼ŒToken sub ä¸º feishu_user_id |
| é£ä¹¦ç™»å½• | è€ç”¨æˆ·å†æ¬¡ç™»å½• | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ŒToken æ­£å¸¸ç”Ÿæˆ |
| Token åˆ·æ–° | ä½¿ç”¨ refresh token è·å–æ–° token | æ–° token çš„ sub ä¸º feishu_user_id |
| æƒé™æŸ¥è¯¢ | æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™ | è¿”å›æ­£ç¡®çš„è§’è‰²å’Œèµ„æºä¿¡æ¯ |
| è§’è‰²åˆ†é… | ä¸ºç”¨æˆ·åˆ†é…è§’è‰² | æ•°æ®åº“è®°å½• user_id ä¸º feishu_user_id |
| èµ„æºç»‘å®š | ç»‘å®šç”¨æˆ·åˆ°èµ„æº | æ•°æ®åº“è®°å½• user_id ä¸º feishu_user_id |
| ç”¨æˆ·çŠ¶æ€ | å¯ç”¨/ç¦ç”¨ç”¨æˆ· | çŠ¶æ€æ›´æ–°æˆåŠŸï¼ŒæŸ¥è¯¢ç»“æœæ­£ç¡® |

**è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼š**
```bash
# è¿è¡Œæµ‹è¯•
pytest tests/ -v -k "test_user" --tb=short

# è¦†ç›–ç‡æ£€æŸ¥
pytest tests/ --cov=app.users --cov-report=html
```

#### 4.4.3 ç«¯åˆ°ç«¯æµ‹è¯•

**å‰ç«¯æµ‹è¯•åœºæ™¯ï¼š**

1. **ç”¨æˆ·åˆ—è¡¨é¡µ**
   - âœ… é¡µé¢æ­£å¸¸åŠ è½½ï¼Œè¡¨æ ¼å±•ç¤ºç”¨æˆ·æ•°æ®
   - âœ… æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
   - âœ… çŠ¶æ€åˆ‡æ¢æŒ‰é’®æ­£å¸¸å·¥ä½œ
   - âœ… æŸ¥çœ‹æƒé™æŒ‰é’®ç‚¹å‡»åå¼¹å‡ºæ­£ç¡®æ•°æ®
   - âœ… åˆ†é…è§’è‰²åŠŸèƒ½æ­£å¸¸

2. **æƒé™ç®¡ç†é¡µ**
   - âœ… è§’è‰²åˆ—è¡¨æ­£å¸¸å±•ç¤º
   - âœ… ä¸ºç”¨æˆ·åˆ†é…è§’è‰²æˆåŠŸ
   - âœ… ç§»é™¤ç”¨æˆ·è§’è‰²æˆåŠŸ

3. **èµ„æºç»‘å®šé¡µ**
   - âœ… èµ„æºç»‘å®šåˆ—è¡¨æ­£å¸¸å±•ç¤º
   - âœ… åˆ›å»ºæ–°çš„èµ„æºç»‘å®šæˆåŠŸ
   - âœ… åˆ é™¤èµ„æºç»‘å®šæˆåŠŸ

**æµ‹è¯•å·¥å…·ï¼š**
- Playwright / Cypress è‡ªåŠ¨åŒ–æµ‹è¯•
- äººå·¥å›å½’æµ‹è¯•æ¸…å•

**é¢„è®¡è€—æ—¶**: 8-10å°æ—¶
**æ‰§è¡Œäººå‘˜**: æµ‹è¯•å›¢é˜Ÿ + å¼€å‘å›¢é˜Ÿ
**éªŒè¯æ ‡å‡†**:
- å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- é›†æˆæµ‹è¯•å…¨éƒ¨é€šè¿‡
- ç«¯åˆ°ç«¯æµ‹è¯•æ ¸å¿ƒæµç¨‹é€šè¿‡

---

### 4.5 ç¬¬äº”é˜¶æ®µï¼šéƒ¨ç½²ä¸Šçº¿

#### 4.5.1 é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²

```bash
# 1. éƒ¨ç½²åç«¯
kubectl apply -f k8s/staging/backend-deployment.yaml

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
kubectl exec -it backend-pod -- alembic upgrade head

# 3. éƒ¨ç½²å‰ç«¯
npm run build:staging
kubectl apply -f k8s/staging/frontend-deployment.yaml

# 4. éªŒè¯éƒ¨ç½²
curl -f https://staging-api.authhub.com/health
curl -f https://staging.authhub.com
```

#### 4.5.2 ç°åº¦å‘å¸ƒç­–ç•¥

**é˜¶æ®µ 1ï¼šå†…éƒ¨æµ‹è¯•ï¼ˆ10% æµé‡ï¼‰**
- ä»…å†…éƒ¨å‘˜å·¥å¯è®¿é—®æ–°ç‰ˆæœ¬
- ç›‘æ§å…³é”®æŒ‡æ ‡ï¼šé”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€ç”¨æˆ·åé¦ˆ
- éªŒè¯æ ¸å¿ƒåŠŸèƒ½ï¼šç™»å½•ã€æƒé™æŸ¥è¯¢ã€è§’è‰²åˆ†é…

**é˜¶æ®µ 2ï¼šå°èŒƒå›´ç”¨æˆ·ï¼ˆ30% æµé‡ï¼‰**
- é€‰æ‹©éƒ¨åˆ†å‹å¥½ç”¨æˆ·è¿›è¡Œæµ‹è¯•
- æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œä¿®å¤å‘ç°çš„é—®é¢˜
- ç›‘æ§æ•°æ®åº“æ€§èƒ½ï¼Œè§‚å¯ŸæŸ¥è¯¢æ•ˆç‡

**é˜¶æ®µ 3ï¼šå…¨é¢å‘å¸ƒï¼ˆ100% æµé‡ï¼‰**
- å…¨é‡å‘å¸ƒæ–°ç‰ˆæœ¬
- å¯†åˆ‡ç›‘æ§ç³»ç»ŸæŒ‡æ ‡
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ

#### 4.5.3 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|------|---------|---------|
| API è¯·æ±‚é”™è¯¯ç‡ | < 0.1% | > 0.5% |
| æ•°æ®åº“æŸ¥è¯¢å¹³å‡è€—æ—¶ | < 100ms | > 200ms |
| ç”¨æˆ·ç™»å½•æˆåŠŸç‡ | > 99% | < 95% |
| é¡µé¢åŠ è½½æ—¶é—´ | < 2s | > 5s |
| Token éªŒè¯å¤±è´¥ç‡ | < 0.01% | > 0.1% |

**é¢„è®¡è€—æ—¶**: 4-6å°æ—¶ï¼ˆåŒ…å«ç›‘æ§æ—¶é—´ï¼‰
**æ‰§è¡Œäººå‘˜**: è¿ç»´å›¢é˜Ÿ + å¼€å‘å›¢é˜Ÿ
**éªŒè¯æ ‡å‡†**:
- ç³»ç»Ÿç¨³å®šè¿è¡Œ 2 å°æ—¶æ— ä¸¥é‡é—®é¢˜
- æ ¸å¿ƒåŠŸèƒ½ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- ç”¨æˆ·åé¦ˆè‰¯å¥½

---

## 5. é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹

### 5.1 å…¼å®¹æ€§å¤„ç†

**é—®é¢˜æè¿°**ï¼š
- æ—§ç‰ˆ Token çš„ sub å­—æ®µå­˜å‚¨çš„æ˜¯ user.idï¼Œæ–°ç‰ˆæ”¹ä¸º feishu_user_id
- å·²å‘å¸ƒçš„å®¢æˆ·ç«¯å¯èƒ½ä»åœ¨ä½¿ç”¨æ—§çš„ API æ¥å£

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **Token å…¼å®¹æ€§æ–¹æ¡ˆ**
   ```python
   async def get_current_user(authorization: str = Header(...)) -> dict:
       token = authorization.replace("Bearer ", "")
       payload = jwt.decode(token, public_key, algorithms=[settings.JWT_ALGORITHM])

       sub = payload.get("sub")

       # åˆ¤æ–­ sub æ˜¯æ—§ç‰ˆ user.id è¿˜æ˜¯æ–°ç‰ˆ feishu_user_id
       if sub.isdigit():
           # æ—§ç‰ˆ Tokenï¼ŒæŸ¥è¯¢ç”¨æˆ·
           result = await db.execute(select(User).filter(User.id == int(sub)))
           user = result.scalar_one_or_none()
           if user:
               # æ›´æ–° payload ä¸ºæ–°ç‰ˆæ ¼å¼
               payload["sub"] = user.feishu_user_id
               return payload
       else:
           # æ–°ç‰ˆ Tokenï¼Œç›´æ¥ä½¿ç”¨
           return payload
   ```

2. **API ç‰ˆæœ¬æ§åˆ¶**
   ```python
   # ä¿ç•™æ—§ç‰ˆ API ä¸€æ®µæ—¶é—´ï¼ˆå¯é€‰ï¼‰
   @router.get("/v1/users/{user_id}", deprecated=True)
   async def get_user_by_old_id(...):
       # å‡è®¾ user_id æ˜¯æ—§ç‰ˆ IDï¼ŒæŸ¥è¯¢ feishu_user_id
       pass

   @router.get("/v2/users/{feishu_user_id}")
   async def get_user(...):
       # æ–°ç‰ˆå®ç°
       pass
   ```

3. **è¿‡æ¸¡æœŸç­–ç•¥**
   - åœ¨ Token ä¸­åŒæ—¶åŒ…å« user.id å’Œ feishu_user_id
   - æœåŠ¡å±‚åŒæ—¶æ”¯æŒä¸¤ç§ ID æŸ¥è¯¢
   - ç»™å®¢æˆ·ç«¯è¶³å¤Ÿçš„å‡çº§æ—¶é—´ï¼ˆå»ºè®® 2-4 å‘¨ï¼‰

### 5.2 æ•°æ®ä¸€è‡´æ€§

**é£é™©ç‚¹ï¼š**
- æ•°æ®åº“è¿ç§»è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´
- å¤–é”®çº¦æŸæ›´æ–°å¤±è´¥å¯¼è‡´å…³è”æ•°æ®å¼‚å¸¸

**åº”å¯¹æªæ–½ï¼š**

1. **è¿ç§»å‰å¤‡ä»½**
   ```bash
   # å…¨é‡å¤‡ä»½
   pg_dump -h localhost -U authhub authhubdb > backup_pre_migration_$(date +%Y%m%d).sql

   # éªŒè¯å¤‡ä»½
   psql -h localhost -U authhub test_restore < backup_pre_migration_$(date +%Y%m%d).sql
   ```

2. **äº‹åŠ¡æ€§è¿ç§»**
   ```python
   # ä½¿ç”¨ Alembic çš„äº‹åŠ¡ç‰¹æ€§
   def upgrade():
       try:
           # æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
           op.execute("BEGIN")
           # ... è¿ç§»é€»è¾‘
           op.execute("COMMIT")
       except Exception as e:
           op.execute("ROLLBACK")
           raise e
   ```

3. **æ•°æ®éªŒè¯è„šæœ¬**
   ```python
   async def verify_migration(db: AsyncSession):
       """éªŒè¯è¿ç§»åæ•°æ®å®Œæ•´æ€§"""
       # æ£€æŸ¥ user_roles è¡¨
       result = await db.execute("""
           SELECT COUNT(*) as mismatch
           FROM user_roles ur
           LEFT JOIN users u ON ur.user_id = u.feishu_user_id
           WHERE u.feishu_user_id IS NULL
       """)
       mismatch = result.scalar()
       if mismatch > 0:
           raise Exception(f"å‘ç° {mismatch} æ¡æ— æ•ˆçš„ç”¨æˆ·è§’è‰²å…³è”")
   ```

### 5.3 æ€§èƒ½ä¼˜åŒ–

**æ½œåœ¨æ€§èƒ½é—®é¢˜ï¼š**
- `feishu_user_id` ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œç´¢å¼•æ•ˆç‡å¯èƒ½ä½äºæ•´å‹
- å¤–é”®å…³è”æŸ¥è¯¢æ€§èƒ½å¯èƒ½ä¸‹é™

**ä¼˜åŒ–ç­–ç•¥ï¼š**

1. **ç´¢å¼•ä¼˜åŒ–**
   ```sql
   -- ç¡®ä¿ feishu_user_id æœ‰ç´¢å¼•
   CREATE INDEX idx_users_feishu_user_id ON users(feishu_user_id);

   -- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
   ANALYZE users;
   ANALYZE user_roles;
   ANALYZE resource_bindings;
   ```

2. **æŸ¥è¯¢ä¼˜åŒ–**
   ```python
   # ä½¿ç”¨ selectinload å‡å°‘ N+1 æŸ¥è¯¢
   from sqlalchemy.orm import selectinload

   result = await db.execute(
       select(User)
       .filter(User.feishu_user_id == feishu_user_id)
       .options(
           selectinload(User.roles),
           selectinload(User.resource_bindings)
       )
   )
   ```

3. **ç¼“å­˜ç­–ç•¥**
   ```python
   # Redis ç¼“å­˜é¢‘ç¹æŸ¥è¯¢çš„ç”¨æˆ·ä¿¡æ¯
   @cached(key="user:{feishu_user_id}", ttl=300)
   async def get_user_by_feishu_id(feishu_user_id: str) -> Optional[User]:
       # æŸ¥è¯¢é€»è¾‘
       pass
   ```

### 5.4 å›æ»šæ–¹æ¡ˆ

**æ•°æ®åº“å›æ»šï¼š**

```python
def downgrade() -> None:
    # 1. æ¢å¤å¤–é”®çº¦æŸ
    op.drop_constraint('user_roles_user_id_fkey', 'user_roles', type_='foreignkey')
    op.create_foreign_key('user_roles_user_id_fkey', 'user_roles', 'users', ['user_id'], ['id'])

    # 2. å­—æ®µç±»å‹å›æ»š
    op.alter_column('user_roles', 'user_id', type_=sa.Integer, nullable=False)

    # 3. æ•°æ®å›æ»šï¼ˆå¦‚æœå¯èƒ½ï¼‰
    # æ³¨æ„ï¼šéœ€è¦æœ‰å¤‡ä»½æ•°æ®
```

**ä»£ç å›æ»šï¼š**

1. **Git åˆ†æ”¯ç­–ç•¥**
   ```bash
   # åˆ›å»ºå‘å¸ƒåˆ†æ”¯
   git checkout -b release/user-id-migration

   # æ‰“æ ‡ç­¾
   git tag -a v1.2.0-migration -m "User ID to Feishu User ID Migration"
   ```

2. **å¿«é€Ÿå›æ»šå‘½ä»¤**
   ```bash
   # å›æ»šæ•°æ®åº“
   alembic downgrade 836823124d94

   # å›æ»šä»£ç 
   git checkout main
   git branch -D release/user-id-migration

   # é‡æ–°éƒ¨ç½²
   kubectl rollout undo deployment/backend
   ```

**å›æ»šè§¦å‘æ¡ä»¶ï¼š**
- API é”™è¯¯ç‡ > 1%
- ç”¨æˆ·ç™»å½•å¤±è´¥ç‡ > 5%
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ä¸‹é™ > 50%
- æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ä¸å¯ç”¨

---

## 6. æ¶‰åŠæ–‡ä»¶æ¸…å•

### 6.1 åç«¯æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|---------|---------|--------|
| `app/core/security.py` | JWT Token ç”Ÿæˆé€»è¾‘ï¼Œsub å­—æ®µæ”¹ä¸º feishu_user_id | ğŸ”´ é«˜ |
| `app/core/dependencies.py` | Token è§£æé€»è¾‘ï¼Œå¤„ç† feishu_user_id | ğŸ”´ é«˜ |
| `app/models/user.py` | å¯é€‰ï¼šè°ƒæ•´ç´¢å¼•ï¼Œä¿æŒ id ä½œä¸ºå†…éƒ¨æ ‡è¯† | ğŸŸ¡ ä¸­ |
| `app/models/user_role.py` | å¤–é”®å­—æ®µç±»å‹ä» int æ”¹ä¸º string | ğŸ”´ é«˜ |
| `app/models/resource_binding.py` | å¤–é”®å­—æ®µç±»å‹ä» int æ”¹ä¸º string | ğŸ”´ é«˜ |
| `app/models/audit_log.py` | operator_id å­—æ®µç±»å‹ä» int æ”¹ä¸º string | ğŸŸ¡ ä¸­ |
| `app/users/service.py` | æ‰€æœ‰æ–¹æ³•ä»ä½¿ç”¨ id æ”¹ä¸º feishu_user_id | ğŸ”´ é«˜ |
| `app/users/router.py` | API è·¯å¾„å‚æ•°ä» user_id: int æ”¹ä¸º feishu_user_id: string | ğŸ”´ é«˜ |
| `app/users/permission_collector.py` | æƒé™æ”¶é›†é€»è¾‘ä½¿ç”¨ feishu_user_id | ğŸ”´ é«˜ |
| `app/auth/router.py` | ç™»å½•ã€åˆ·æ–° token é€»è¾‘ä½¿ç”¨ feishu_user_id | ğŸ”´ é«˜ |
| `app/auth/feishu.py` | å¯é€‰ï¼šä¼˜åŒ–ç”¨æˆ·åŒæ­¥é€»è¾‘ | ğŸŸ¢ ä½ |
| `app/rbac/service.py` | è§’è‰²åˆ†é…ã€æƒé™ç®¡ç†ä½¿ç”¨ feishu_user_id | ğŸ”´ é«˜ |
| `app/rbac/router.py` | API æ¥å£å‚æ•°ç±»å‹ä¿®æ”¹ | ğŸ”´ é«˜ |
| `app/schemas/user.py` | Response schema æ›´æ–° | ğŸŸ¡ ä¸­ |
| `app/schemas/rbac.py` | RBAC ç›¸å…³ schema æ›´æ–° | ğŸŸ¡ ä¸­ |
| `alembic/versions/xxx_migration.py` | æ•°æ®åº“è¿ç§»è„šæœ¬ | ğŸ”´ é«˜ |

### 6.2 å‰ç«¯æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | ä¼˜å…ˆçº§ |
|---------|---------|--------|
| `src/types/api.ts` | User æ¥å£ id: number â†’ feishu_user_id: string | ğŸ”´ é«˜ |
| `src/pages/Users/UserList.tsx` | è¡¨æ ¼ rowKeyã€æ“ä½œæŒ‰é’®ä¼ å‚ | ğŸ”´ é«˜ |
| `src/pages/Users/components/UserPermissionModal.tsx` | Props æ¥å£ userId ç±»å‹ | ğŸ”´ é«˜ |
| `src/pages/Users/components/AssignRoleModal.tsx` | Props æ¥å£ userId ç±»å‹ | ğŸ”´ é«˜ |
| `src/contexts/AuthContext.tsx` | å¯é€‰ï¼šç”¨æˆ·æ ‡è¯†å¤„ç† | ğŸŸ¡ ä¸­ |
| `src/utils/api.ts` | API è¯·æ±‚å‡½æ•°å‚æ•°ç±»å‹ | ğŸ”´ é«˜ |

### 6.3 æ•°æ®åº“è¡¨

| è¡¨å | ä¿®æ”¹å­—æ®µ | å˜æ›´ç±»å‹ | å½±å“ |
|------|---------|---------|------|
| `users` | `feishu_user_id` | æ·»åŠ ç´¢å¼•ï¼ˆå¦‚ç¼ºå¤±ï¼‰ | ä¸­ |
| `user_roles` | `user_id`, `created_by` | int â†’ string | é«˜ |
| `resource_bindings` | `user_id`, `created_by` | int â†’ string | é«˜ |
| `audit_logs` | `operator_id` | int â†’ string | ä¸­ |

---

## 7. æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡å·¥æ—¶ | æ‰§è¡Œäººå‘˜ |
|------|------|---------|---------|
| 1 | æ•°æ®åº“è¿ç§» | 4-6å°æ—¶ | åç«¯ + DBA |
| 2 | åç«¯ä»£ç é‡æ„ | 8-12å°æ—¶ | åç«¯å›¢é˜Ÿï¼ˆ2äººï¼‰ |
| 3 | å‰ç«¯ä»£ç é‡æ„ | 6-8å°æ—¶ | å‰ç«¯å›¢é˜Ÿï¼ˆ1-2äººï¼‰ |
| 4 | æµ‹è¯•éªŒè¯ | 8-10å°æ—¶ | æµ‹è¯• + å¼€å‘ |
| 5 | éƒ¨ç½²ä¸Šçº¿ | 4-6å°æ—¶ | è¿ç»´ + å¼€å‘ |
| **æ€»è®¡** | | **30-42å°æ—¶** | **5-6äººå¤©** |

**å»ºè®®æ’æœŸï¼š**
- **Week 1**: æ•°æ®åº“è¿ç§» + åç«¯é‡æ„ï¼ˆ3å¤©ï¼‰
- **Week 2**: å‰ç«¯é‡æ„ + å•å…ƒæµ‹è¯•ï¼ˆ2å¤©ï¼‰
- **Week 3**: é›†æˆæµ‹è¯• + éƒ¨ç½²å‡†å¤‡ï¼ˆ2å¤©ï¼‰
- **Week 4**: ç°åº¦å‘å¸ƒ + ç›‘æ§ + ä¼˜åŒ–ï¼ˆ3å¤©ï¼‰

---

## 8. ç›¸å…³æ–‡æ¡£

- [é£ä¹¦ OAuth2.0 é›†æˆæ–‡æ¡£](./authentication/feishu-oauth.md)
- [JWT Token è®¾è®¡ä¸å®ç°](./authentication/jwt-implementation.md)
- [RBAC æƒé™ç³»ç»Ÿè®¾è®¡](./rbac/design.md)
- [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./architecture/database-schema.md)
- [API æ¥å£æ–‡æ¡£](./api/README.md)

---

## 9. é™„å½•

### 9.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **feishu_user_id** | é£ä¹¦ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼Œå¯¹åº”é£ä¹¦å¼€æ”¾å¹³å°çš„ user_id æˆ– open_id |
| **id** | ç³»ç»Ÿå†…éƒ¨è‡ªå¢æ•´æ•°æ ‡è¯†ï¼Œå½“å‰ä½œä¸ºä¸»é”®ä½¿ç”¨ |
| **JWT** | JSON Web Tokenï¼Œç”¨äºç”¨æˆ·è®¤è¯å’Œæˆæƒ |
| **RBAC** | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRole-Based Access Controlï¼‰ |
| **sub** | JWT Token çš„æ ‡å‡†å­—æ®µï¼Œè¡¨ç¤ºä¸»é¢˜ï¼ˆSubjectï¼‰ï¼Œé€šå¸¸å­˜å‚¨ç”¨æˆ·æ ‡è¯† |

### 9.2 è”ç³»æ–¹å¼

- **é¡¹ç›®è´Ÿè´£äºº**: [å§“å]
- **æŠ€æœ¯è´Ÿè´£äºº**: [å§“å]
- **æ•°æ®åº“è´Ÿè´£äºº**: [å§“å]
- **æµ‹è¯•è´Ÿè´£äºº**: [å§“å]

---

**æ–‡æ¡£å˜æ›´è®°å½•**

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 1.0 | 2025-11-28 | åˆå§‹ç‰ˆæœ¬ | Claude Code |

---

**å®¡æ‰¹è®°å½•**

| å®¡æ‰¹äºº | è§’è‰² | å®¡æ‰¹æ—¥æœŸ | çŠ¶æ€ |
|--------|------|---------|------|
| | | | |
| | | | |
| | | | |

---

*æœ¬æ–‡æ¡£ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆï¼ŒåŸºäºå¯¹ä»£ç åº“çš„å…¨é¢åˆ†æ*
*æœ€åæ›´æ–°: 2025-11-28*
