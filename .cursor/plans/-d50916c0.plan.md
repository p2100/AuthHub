<!-- d50916c0-dab0-4df6-8745-34c246f6bca9 68233dd7-d113-4a5c-b314-38605d1c4ded -->
# 后台认证与动态数据加载实施计划

## 现状分析

**问题1：缺少认证保护**

- 前端路由完全开放，任何人可直接访问 `/dashboard` 等管理页面
- 未实现飞书登录回调的token处理和存储
- 没有路由守卫检查用户登录状态和管理员权限

**问题2：仪表盘数据写死**

- Dashboard页面显示硬编码数据（系统数:5、用户数:128、角色数:15）
- 后端尚未提供统计数据API接口

## 实施方案

### 一、后端开发

#### 1. 新增统计数据API接口

在 `backend/app/rbac/router.py` 中新增统计接口：

```python
@router.get("/stats")
async def get_stats(
    current_user: dict = Depends(require_admin),
    db: AsyncSession = Depends(get_db)
):
    """获取系统统计数据（需要管理员权限）"""
```

返回数据包括：

- 系统总数
- 用户总数  
- 角色总数

#### 2. 新增Schema定义

在 `backend/app/schemas/rbac.py` 中添加：

```python
class StatsResponse(BaseModel):
    system_count: int
    user_count: int
    role_count: int
```

### 二、前端开发

#### 1. 认证状态管理

**创建 AuthContext** (`frontend/src/contexts/AuthContext.tsx`)

- 管理token存储（localStorage）
- 管理用户信息状态
- 提供登录、登出、获取当前用户等方法
- 检查管理员权限（判断 `global_roles` 是否包含 `"admin"`）

#### 2. 路由守卫

**创建 ProtectedRoute 组件** (`frontend/src/components/ProtectedRoute.tsx`)

- 检查token是否存在
- 验证管理员权限
- 未登录重定向到 `/login`
- 非管理员显示403提示

**修改路由配置** (`frontend/src/App.tsx`)

- 使用ProtectedRoute包裹所有管理后台路由
- 保留登录页面和回调页面为公开访问

#### 3. 飞书登录回调处理

**创建回调页面** (`frontend/src/pages/Login/Callback.tsx`)

- 解析URL中的code参数
- 调用后端 `/api/v1/auth/feishu/callback` 换取token
- 存储token到localStorage
- 调用 `/api/v1/auth/me` 获取用户信息
- 验证管理员权限
- 跳转到仪表盘或显示权限不足提示

#### 4. API工具函数

**创建API工具** (`frontend/src/utils/api.ts`)

- 封装fetch请求
- 自动添加Authorization头
- 统一错误处理（401跳转登录，403权限不足提示）
- 使用TypeScript类型定义

#### 5. 仪表盘动态数据

**改造Dashboard组件** (`frontend/src/pages/Dashboard/index.tsx`)

- 使用 `@tanstack/react-query` 的 `useQuery` 获取统计数据
- 调用后端 `/api/v1/rbac/stats` 接口
- 添加加载状态和错误处理
- 移除硬编码数据

#### 6. 布局组件增强

**改造MainLayout** (`frontend/src/components/Layout/MainLayout.tsx`)

- 显示当前用户信息
- 添加登出按钮
- 调用登出API并清除token

## 关键技术点

- **Token存储**：使用localStorage持久化
- **权限判断**：检查JWT payload中的 `global_roles` 数组是否包含 `"admin"`
- **API认证**：所有请求携带 `Authorization: Bearer <token>` 头
- **路由保护**：使用高阶组件包裹需要保护的路由
- **异步优先**：所有API调用使用async/await
- **类型安全**：使用TypeScript定义所有数据类型

## 文件清单

**后端新增/修改**

- `backend/app/rbac/router.py` - 新增stats接口
- `backend/app/schemas/rbac.py` - 新增StatsResponse

**前端新增**

- `frontend/src/contexts/AuthContext.tsx` - 认证上下文
- `frontend/src/components/ProtectedRoute.tsx` - 路由守卫
- `frontend/src/pages/Login/Callback.tsx` - 登录回调页面
- `frontend/src/utils/api.ts` - API工具
- `frontend/src/types/api.ts` - API类型定义

**前端修改**

- `frontend/src/App.tsx` - 路由配置
- `frontend/src/pages/Dashboard/index.tsx` - 动态数据加载
- `frontend/src/components/Layout/MainLayout.tsx` - 用户信息和登出
- `frontend/src/main.tsx` - 包裹AuthProvider

### To-dos

- [ ] 后端新增统计数据API接口 (/api/v1/rbac/stats)
- [ ] 后端新增StatsResponse Schema定义
- [ ] 创建前端API工具函数和类型定义
- [ ] 创建AuthContext认证上下文管理
- [ ] 创建ProtectedRoute路由守卫组件
- [ ] 创建飞书登录回调页面处理
- [ ] 修改路由配置添加认证保护
- [ ] 改造Dashboard组件使用动态数据
- [ ] 改造MainLayout显示用户信息和登出功能