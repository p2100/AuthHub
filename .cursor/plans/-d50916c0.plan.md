<!-- d50916c0-dab0-4df6-8745-34c246f6bca9 4c3c39e9-23b6-439d-b658-5e9f0e2a6439 -->
# 完善管理后台功能

## 1. 后端API完善

### 1.1 用户管理模块

创建 `backend/app/users/router.py`，实现：

- `GET /api/v1/users` - 获取用户列表（支持分页、搜索、部门筛选）
- `GET /api/v1/users/{user_id}` - 获取用户详情
- `PUT /api/v1/users/{user_id}/status` - 启用/禁用用户
- `GET /api/v1/users/{user_id}/roles` - 获取用户的角色列表
- `GET /api/v1/users/{user_id}/permissions` - 获取用户的权限详情

需要修改：

- `backend/app/users/service.py` - 转换为异步，添加列表查询、状态更新等方法
- `backend/app/main.py` - 注册用户管理路由

### 1.2 系统管理模块

修改 `backend/app/systems/router.py` 和 `service.py`：

- 转换所有方法为异步（`AsyncSession`、`await db.execute(select())`）
- `PUT /api/v1/systems/{system_id}` - 更新系统信息
- `PUT /api/v1/systems/{system_id}/status` - 启用/禁用系统
- `GET /api/v1/systems/{system_id}/roles` - 获取系统的角色列表
- `GET /api/v1/systems/{system_id}/permissions` - 获取系统的权限列表
- `POST /api/v1/systems/{system_id}/token/regenerate` - 重新生成系统Token

### 1.3 角色管理模块

修改 `backend/app/rbac/router.py` 和 `service.py`：

- `PUT /api/v1/rbac/roles/{role_id}` - 更新角色信息
- `DELETE /api/v1/rbac/roles/{role_id}` - 删除角色（软删除或检查关联）
- `GET /api/v1/rbac/roles/{role_id}` - 获取角色详情
- `GET /api/v1/rbac/roles/{role_id}/users` - 获取拥有该角色的用户列表
- `DELETE /api/v1/rbac/users/{user_id}/roles/{role_id}` - 移除用户角色

需要转换 `rbac/service.py` 中的同步代码为异步。

### 1.4 权限管理模块

修改 `backend/app/rbac/router.py`：

- `PUT /api/v1/rbac/permissions/{permission_id}` - 更新权限
- `DELETE /api/v1/rbac/permissions/{permission_id}` - 删除权限
- `PUT /api/v1/rbac/routes/{route_id}` - 更新路由规则
- `DELETE /api/v1/rbac/routes/{route_id}` - 删除路由规则
- `GET /api/v1/rbac/resource-bindings` - 获取资源绑定列表

### 1.5 Schema定义

需要添加/更新以下Schema文件：

- `backend/app/schemas/user.py` - 用户相关的请求/响应模型
- 更新 `backend/app/schemas/system.py` - 添加更新系统的Schema
- 更新 `backend/app/schemas/rbac.py` - 添加更新、删除相关的Schema

## 2. 前端功能实现

### 2.1 用户管理页面 (`frontend/src/pages/Users/UserList.tsx`)

- 使用 `useQuery` 获取用户列表
- 添加搜索框（按用户名、邮箱搜索）
- 添加部门筛选下拉框
- 实现表格分页
- 操作列：
- 查看权限（打开Modal显示用户的角色和权限详情）
- 分配角色（打开Modal，多选角色，调用分配API）
- 启用/禁用（Switch开关或按钮）

创建子组件：

- `UserPermissionModal.tsx` - 查看用户权限详情
- `AssignRoleModal.tsx` - 分配角色（可复用）

### 2.2 系统管理页面 (`frontend/src/pages/Systems/SystemList.tsx`)

- 使用 `useQuery` 获取系统列表
- "注册新系统"按钮打开Modal
- 操作列：
- 查看详情（打开Drawer显示系统信息、Token、关联的角色和权限）
- 编辑（打开Modal编辑系统信息）
- 重新生成Token（确认后调用API，显示新Token）

创建子组件：

- `CreateSystemModal.tsx` - 创建系统
- `SystemDetailDrawer.tsx` - 查看系统详情
- `EditSystemModal.tsx` - 编辑系统

### 2.3 角色管理页面 (`frontend/src/pages/Roles/RoleList.tsx`)

- 使用 `useQuery` 获取角色列表
- 系统筛选下拉框（从系统列表API获取）
- "创建角色"按钮打开Modal
- 操作列：
- 配置权限（打开Modal，多选权限，调用更新API）
- 编辑（打开Modal编辑角色信息）
- 删除（确认后调用API）
- 查看用户（打开Drawer显示拥有该角色的用户列表）

创建子组件：

- `CreateRoleModal.tsx` - 创建角色
- `EditRoleModal.tsx` - 编辑角色
- `ConfigureRolePermissionsModal.tsx` - 配置角色权限
- `RoleUsersDrawer.tsx` - 查看角色用户

### 2.4 权限管理页面 (`frontend/src/pages/Permissions/PermissionList.tsx`)

- Tab 1：权限列表
- 使用 `useQuery` 获取权限列表
- 添加"创建权限"按钮
- 操作列：编辑、删除
- Tab 2：路由规则
- 使用 `useQuery` 获取路由规则列表
- 添加"创建路由规则"按钮
- 操作列：编辑、删除
- Tab 3：资源绑定
- 使用 `useQuery` 获取资源绑定列表
- 显示用户、资源类型、资源ID、操作等信息

创建子组件：

- `CreatePermissionModal.tsx` - 创建权限
- `EditPermissionModal.tsx` - 编辑权限
- `CreateRouteModal.tsx` - 创建路由规则
- `EditRouteModal.tsx` - 编辑路由规则

### 2.5 类型定义

更新 `frontend/src/types/api.ts`，添加：

- 用户相关类型（`User`, `UserListResponse`, `UserPermissionDetail`等）
- 系统相关类型（`System`, `SystemDetail`等）
- 角色相关类型（`Role`, `RoleDetail`等）
- 权限相关类型（`Permission`, `RoutePattern`, `ResourceBinding`等）

## 3. 代码质量保证

- 所有后端异步方法使用 `async/await`
- 前端使用 `useMutation` 处理增删改操作，操作成功后使用 `queryClient.invalidateQueries` 刷新列表
- 添加适当的错误处理和用户提示（`message.success`, `message.error`）
- 表单验证使用 Ant Design 的 Form 组件
- 确认操作使用 `Modal.confirm`

## 4. 实施顺序

1. 后端用户管理API + Schema
2. 前端用户管理页面
3. 后端系统管理API改造（异步）+ 新增功能
4. 前端系统管理页面
5. 后端角色管理API改造 + 新增功能
6. 前端角色管理页面
7. 后端权限管理API新增功能
8. 前端权限管理页面

### To-dos

- [ ] 创建用户管理API路由和服务（异步），包括列表、详情、状态更新、角色/权限查询
- [ ] 创建用户相关的Schema定义
- [ ] 在 api.ts 中添加用户相关的类型定义
- [ ] 实现用户管理页面，包括列表、搜索、分页、查看权限、分配角色、启用/禁用功能
- [ ] 将系统管理服务转换为异步，并添加更新、状态管理、Token重新生成等API
- [ ] 更新系统管理相关的Schema定义
- [ ] 在 api.ts 中添加系统相关的类型定义
- [ ] 实现系统管理页面，包括列表、创建、编辑、查看详情、重新生成Token功能
- [ ] 将角色管理服务转换为异步，并添加更新、删除、查询角色用户等API
- [ ] 更新角色管理相关的Schema定义
- [ ] 在 api.ts 中添加角色相关的类型定义
- [ ] 实现角色管理页面，包括列表、创建、编辑、删除、配置权限、查看用户功能
- [ ] 添加权限管理的更新、删除API，以及路由规则和资源绑定的增删改查
- [ ] 更新权限管理相关的Schema定义
- [ ] 在 api.ts 中添加权限、路由规则、资源绑定的类型定义
- [ ] 实现权限管理页面三个Tab，包括权限列表、路由规则、资源绑定的完整CRUD功能